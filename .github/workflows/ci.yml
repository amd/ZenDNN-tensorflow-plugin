name: ZenDNN TensorFlow Plugin Precheck

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NFS_LOC: ~/datasets/
  CHECK_TYPE: keyword_check
  KEYWORD_CHECK_PATHS: "$GITHUB_WORKSPACE/ZenDNN_TensorFlow_Plugin/*,$GITHUB_WORKSPACE/ZenDNN_TensorFlow_Plugin/scripts/**,$GITHUB_WORKSPACE/ZenDNN_TensorFlow_Plugin/tests/**,$GITHUB_WORKSPACE/ZenDNN_TensorFlow_Plugin/tensorflow_plugin/**"
  IGN_KWD_CHK_PATHS: "BUILD,.bzl,.patch,.build,third_party"
  UNWANTED_KEYWORDS: "stackoverflow,MSDN,wiki,microsoft"
  NFS_MOUNT_POINT: daytonax1670.amd.com:/home/ext_hdd/datasets

jobs:
  precheck:
    runs-on: precheck_runner  # must be self-hosted to allow NFS mount
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare environment
        run: |
          eval NFS_LOC=$NFS_LOC
          export PATH="$HOME/anaconda3/bin:$PATH"
          eval "$(conda shell.bash hook)"
          echo "WORKSPACE=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          echo "Workspace: $GITHUB_WORKSPACE"
          echo "PATH: $PATH"
        shell: bash

      - name: Fix permissions and clean caches
        run: |
          sudo chmod -R 777 $HOME/anaconda3/
          sudo chmod -R 777 $HOME/.conda/
          sudo chmod -R 777 $HOME/.cache/
          sudo rm -rf ~/.cache/* ~/.local/* ~/.conda/*
          conda init bash
          source ~/.bashrc
        shell: bash

      - name: Install NFS utilities and mount
        run: |
          echo "${{ secrets.JENKINS_PASSWD }}" | sudo -S apt-get install -y nfs-common
          mkdir -p $NFS_LOC
          sudo mount $NFS_MOUNT_POINT $NFS_LOC
        shell: bash

      - name: Setup workspace symlinks
        run: |
          rm -rf $GITHUB_WORKSPACE/ZenDNN_TensorFlow_Plugin
          rm -rf $GITHUB_WORKSPACE/ZenDNN_tools
          ln -sf $GITHUB_WORKSPACE/../$CLONED_JENKINS_JOB/ZenDNN_TensorFlow_Plugin $GITHUB_WORKSPACE
          ln -sf $GITHUB_WORKSPACE/../$CLONED_JENKINS_JOB/ZenDNN_tools $GITHUB_WORKSPACE
        shell: bash

      - name: Run Precheck Script
        working-directory: ${{ github.workspace }}/ZenDNN_tools/scripts/ci
        run: |
          chmod 755 zendnn_ci_tf_plugin_presub_check.sh
          source zendnn_ci_tf_plugin_presub_check.sh
        shell: bash

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: precheck-results
          path: |
            *.txt
            *.properties

      - name: Cleanup workspace and caches
        if: always()
        run: |
          echo "Cleaning up workspace and caches..."
          
          # Unmount NFS if mounted
          if mountpoint -q "$NFS_LOC"; then
            sudo umount $NFS_LOC || echo "NFS unmount failed"
          fi

          # Remove workspace symlinks
          rm -rf $GITHUB_WORKSPACE/ZenDNN_TensorFlow_Plugin
          rm -rf $GITHUB_WORKSPACE/ZenDNN_tools

          # Reset conda caches and permissions
          sudo rm -rf ~/.cache/* ~/.local/* ~/.conda/*
          sudo chmod -R 777 $HOME/anaconda3/
          sudo chmod -R 777 $HOME/.conda/
          sudo chmod -R 777 $HOME/.cache/
          
          echo "Cleanup completed"
        shell: bash
