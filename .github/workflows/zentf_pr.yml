name: ZenDNN TensorFlow Plugin CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      zendnn_ref:
        description: 'ZenDNN branch or PR ref (optional, e.g. refs/pull/123/head)'
        required: false
        default: ''
      zentf_use_local_zendnn:
        description: 'Set to 1 to use local ZenDNN'
        required: false
        default: '1'
      zentf_use_local_blis:
        description: 'Set to 1 to use local BLIS'
        required: false
        default: '1'
  repository_dispatch:
    types: [zendnn-pr]

jobs:
  build:
    runs-on: [zentf_presub]
    env:
      PYTHON_VERSION: '3.10'
      ZENDNN_VERSION: '5.2.0'
      ZENDNN_TF_VERSION: '2.19.0'
      NATIVE_TF_VERSION: '2.19.0'
      blis_release_hash: '9d639f1a874492ac7668cba2c25623eb6dca7203a4aeae757ce7e62ca87bc319'
      blis_release_version: 'AOCL-Sep2025-b1'
      zendnn_release_hash: '622f0da3e5f1af153d5aba7e81e98e6a45898d85127231bfc48848128cbf3c15'
      zendnn_release_version: 'zendnn-2025-WW38'
      TF_PLUGIN_USE_LOCAL_ZENDNN: ${{ github.event.inputs.zentf_use_local_zendnn || github.event.client_payload.zentf_use_local_zendnn || '1' }}
      TF_PLUGIN_USE_LOCAL_BLIS: ${{ github.event.inputs.zentf_use_local_blis || github.event.client_payload.zentf_use_local_blis || '1' }}
      BLIS_TAR_BALL: 'AOCL-Sep2025-b1.tar.gz'
      ZENDNN_REF: ${{ github.event.inputs.zendnn_ref || github.event.client_payload.zendnn_ref || '' }}
    steps:
      - name: Setup working directories
        run: |
          # Get the parent directory of the GitHub workspace
          # If GITHUB_WORKSPACE is /proj/zendai/gh_actions_zenai/presub/actions-runner-zendnn-presub-3/workspace/ZenDNN_TensorFlow_Plugin
          # then BASE_DIR would be /proj/zendai/gh_actions_zenai/presub/actions-runner-zendnn-presub-3/workspace
          BASE_DIR=$(dirname "$GITHUB_WORKSPACE")
          echo "BASE_DIR=$BASE_DIR" >> $GITHUB_ENV
          
          # Clean up existing directories if they exist
          if [ -d "$BASE_DIR/ZenDNN" ]; then
            echo "Removing existing ZenDNN directory"
            rm -rf "$BASE_DIR/ZenDNN"
          fi
          if [ -d "$BASE_DIR/ZenDNN_tools" ]; then
            echo "Removing existing ZenDNN_tools directory"
            rm -rf "$BASE_DIR/ZenDNN_tools"
          fi
          if [ -d "$BASE_DIR/blis" ]; then
            echo "Removing existing blis directory"
            rm -rf "$BASE_DIR/blis"
          fi
          
          # Remove any nested ZenDNN_TensorFlow_Plugin if it exists
          if [ -d "$GITHUB_WORKSPACE/ZenDNN_TensorFlow_Plugin" ]; then
            echo "Removing nested ZenDNN_TensorFlow_Plugin directory"
            rm -rf "$GITHUB_WORKSPACE/ZenDNN_TensorFlow_Plugin"
          fi
          
          # Set these to be consistent with your existing scripts
          echo "PARENT_DIR=$BASE_DIR" >> $GITHUB_ENV
          echo "WORKSPACE=$BASE_DIR" >> $GITHUB_ENV
        shell: bash

      - name: Checkout ZenDNN_TensorFlow_Plugin
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # No path - this will check out directly into GITHUB_WORKSPACE which is what we want
          
      - name: Verify checkout
        run: |
          echo "Current directory structure:"
          echo "GITHUB_WORKSPACE = $GITHUB_WORKSPACE"
          echo "BASE_DIR = $BASE_DIR"
          echo "PARENT_DIR = $PARENT_DIR"
          echo "WORKSPACE = $WORKSPACE"
          
          # List the files in GITHUB_WORKSPACE
          echo "Contents of GITHUB_WORKSPACE:"
          ls -la "$GITHUB_WORKSPACE"
          
          # Make sure we're in the right place with essential files
          if [ ! -f "$GITHUB_WORKSPACE/configure.py" ]; then
            echo "ERROR: configure.py not found in GITHUB_WORKSPACE - checkout may have failed"
            exit 1
          fi
          
          # Create a symlink from parent/ZenDNN_TensorFlow_Plugin to GITHUB_WORKSPACE for compatibility
          ln -sf "$GITHUB_WORKSPACE" "$BASE_DIR/ZenDNN_TensorFlow_Plugin"
        shell: bash

      - name: Clone ZenDNN if needed
        if: env.TF_PLUGIN_USE_LOCAL_ZENDNN == '1'
        run: |
          git clone --depth 1 --branch main https://${{ secrets.ZIAIE_PAT }}@github.com/AMD-Zenai/ZenDNN.git "$BASE_DIR/ZenDNN"
          if [ "${ZENDNN_REF}" != "" ]; then
            cd "$BASE_DIR/ZenDNN"
            git fetch origin "${ZENDNN_REF}"
            git checkout FETCH_HEAD
          fi
        shell: bash

      - name: Copy and extract BLIS tarball if needed
        if: env.TF_PLUGIN_USE_LOCAL_BLIS == '1'
        run: |
          cp /proj/zendai/datasets/ci_zendnn_presub_dependencies/$BLIS_TAR_BALL "$BASE_DIR/"
          tar -xzf "$BASE_DIR/$BLIS_TAR_BALL" -C "$BASE_DIR/"
        shell: bash

      - name: Clone ZenDNN_tools
        run: |
          git clone --depth 1 --branch main https://${{ secrets.ZIAIE_PAT }}@github.com/AMD-Zenai/ZenDNN_tools.git "$BASE_DIR/ZenDNN_tools"
        shell: bash

      - name: Directory structure check
        run: |
          echo "Current directory structure:"
          find $BASE_DIR -maxdepth 1 | sort
        shell: bash

      - name: Run CI script
        run: |
          sed -i 's/sudo//g' "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_presub_build.sh"
          sed -i '/mkmhub/ s/mkmhub/-v \/proj\/zendai:\/proj\/zendai mkmhub/' "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_presub_build.sh"
          sed -i "s|zentf-\$ZENDNN_VERSION-tf-\$ZENDNN_TF_VERSION|zentf-\$ZENDNN_VERSION-tf-\$ZENDNN_TF_VERSION-xco|g" "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_presub_build.sh"
          sed -i 's|/root/anaconda3/|/proj/zendai_conda/miniforge3/|g' "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_build.sh"
          sed -i 's/^\(conda init bash\|conda config --set auto_activate_base false\|source ~\/.bashrc\)/# \1/' "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_build.sh"
          sed -i '/echo "host_pid" \$host_pid/a mkdir -p /tmp/bazelisk_bin\nexport XDG_CACHE_HOME=/tmp/bazelisk_bin' "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_build.sh"
          sed -i '/\/usr\/local\/bin\/bazel version/ s|version|--output_user_root="/tmp/bazelisk_bin" version|' "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_build.sh"
          sed -i 's|echo `bazel version`|echo `bazel --output_user_root="/tmp/bazelisk_bin" version`|g' "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_build.sh"
          sed -i 's|^[[:space:]]*bazel clean.*|bazel --output_user_root="/tmp/bazelisk_bin" clean --expunge|' "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_build.sh"
          sed -i 's|^[[:space:]]*bazel build|bazel --output_user_root="/tmp/bazelisk_bin" build|g' "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_build.sh"
          sed -i "s/\(\['bazel',\)/\1 '--output_user_root=\/tmp\/bazelisk_bin',/" "$GITHUB_WORKSPACE/configure.py"
          sed -i "/import os/a bazel_cache = '/tmp/bazelisk_bin'" "$GITHUB_WORKSPACE/configure.py"
          sed -i "s|'--output_user_root=\/tmp/bazelisk_bin'|f'--output_user_root={bazel_cache}'|g" "$GITHUB_WORKSPACE/configure.py"
          
          # Set environment variables for the CI script
          export PYTHON_VERSION=${{ env.PYTHON_VERSION }}
          export BUILD_PYTHON_VERSIONS=${{ env.PYTHON_VERSION }}
          export ZENDNN_VERSION=${{ env.ZENDNN_VERSION }}
          export ZENDNN_TF_VERSION=${{ env.ZENDNN_TF_VERSION }}
          export WORKSPACE=${{ env.WORKSPACE }}
          export ZENTF_USE_LOCAL_ZENDNN=${{ env.TF_PLUGIN_USE_LOCAL_ZENDNN }}
          export ZENTF_USE_LOCAL_BLIS=${{ env.TF_PLUGIN_USE_LOCAL_BLIS }}
          export NATIVE_TF_VERSION=${{ env.NATIVE_TF_VERSION }}
          export UNWANTED_KEYWORDS=${{ env.UNWANTED_KEYWORDS }}
          export BLIS_TAR_BALL=${{ env.BLIS_TAR_BALL }}
          export zendnn_release_version=${{ env.zendnn_release_version }}
          export zendnn_release_hash=${{ env.zendnn_release_hash }}
          export blis_release_hash=${{ env.blis_release_hash }}
          export blis_release_version=${{ env.blis_release_version }}
          export PARENT_DIR=${{ env.PARENT_DIR }}
          
          # Run the CI script
          bash "$BASE_DIR/ZenDNN_tools/scripts/ci/zendnn_ci_tf_plugin_presub_build.sh"
        shell: bash

      - name: Fail if script failed
        if: failure()
        run: exit 1
        
      - name: Archive build artifacts
        if: always()  # Always run this step regardless of job outcome
        uses: actions/upload-artifact@v4
        with:
          name: zentf-artifacts
          path: |
            ${{ env.BASE_DIR }}/*.whl
            ${{ env.GITHUB_WORKSPACE }}/bazel_build_output.txt
            
      - name: Cleanup workspace
        if: always()
        run: |
          echo "Cleaning up workspace"
          
          # Archive the artifacts to a temporary location before deletion (as backup)
          mkdir -p /tmp/zentf_artifacts
          cp -f ${{ env.BASE_DIR }}/*.whl /tmp/zentf_artifacts/ 2>/dev/null || true
          cp -f ${{ env.GITHUB_WORKSPACE }}/bazel_build_output.txt /tmp/zentf_artifacts/ 2>/dev/null || true
          
          # List what we'll be cleaning up
          echo "Contents before cleanup:"
          find $BASE_DIR -maxdepth 1 | sort
          
          # Remove all components (but be careful not to delete parent workspace)
          rm -rf "$BASE_DIR/ZenDNN" "$BASE_DIR/ZenDNN_tools" "$BASE_DIR/blis" "$BASE_DIR/$BLIS_TAR_BALL" "$BASE_DIR"/*.whl
          
          # Clean the main repo files but don't delete the directory itself
          find $GITHUB_WORKSPACE -mindepth 1 -delete 2>/dev/null || true
          
          # Verify the cleanup
          echo "Contents after cleanup:"
          find $BASE_DIR -maxdepth 1 | sort
          echo "Workspace cleaned up successfully"
        shell: bash
